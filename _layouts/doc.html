---
layout: default
---

<div class="doc-wrapper">
  <article class="doc-article">
    <header class="doc-header">
      <h1>{{ page.title }}</h1>
      <div class="doc-meta">
        <span>åˆ†ç±»: {{ page.category }}</span>
        <span>æ›´æ–°: {{ page.date | date: "%Y-%m-%d" }}</span>
      </div>
    </header>

    <!-- ç§»åŠ¨ç«¯ç›®å½•æŠ˜å æŒ‰é’® -->
    <div class="mobile-toc-toggle">
      <button id="mobileTocBtn" class="toc-toggle-btn">
        <span class="toc-icon">ğŸ“‘</span>
        <span class="toc-text">ç›®å½•</span>
        <span class="toc-arrow">â–¼</span>
      </button>
      <div id="mobileTocContent" class="mobile-toc-content">
        <nav id="mobileTocNav"></nav>
      </div>
    </div>

    <div class="doc-content" id="docContent">
      {{ content }}
    </div>

    {% if page.tags %}
    <div class="doc-tags">
      {% for tag in page.tags %}
      <span class="tag">{{ tag }}</span>
      {% endfor %}
    </div>
    {% endif %}
  </article>

  <aside class="doc-toc">
    <div class="toc-sticky" id="tocSticky">
      <h3>ç›®å½•</h3>
      <nav id="tocNav"></nav>
    </div>
  </aside>
</div>

<script>
  // ç”Ÿæˆç›®å½•
  document.addEventListener('DOMContentLoaded', function() {
    const content = document.getElementById('docContent');
    const tocNav = document.getElementById('tocNav');
    const mobileTocNav = document.getElementById('mobileTocNav');
    const tocSticky = document.getElementById('tocSticky');
    const mobileTocToggle = document.querySelector('.mobile-toc-toggle');
    const mobileTocBtn = document.getElementById('mobileTocBtn');
    const mobileTocContent = document.getElementById('mobileTocContent');

    if (!content || !tocNav) return;

    // åŠ¨æ€è®¾ç½®ç›®å½•ä½ç½®ï¼Œä¸æ–‡æ¡£é¡¶éƒ¨å¯¹é½
    function updateTocPosition() {
      const docArticle = document.querySelector('.doc-article');
      if (docArticle) {
        const rect = docArticle.getBoundingClientRect();
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const articleTop = rect.top + scrollTop;

        tocSticky.style.top = Math.max(80, articleTop - scrollTop) + 'px';
      }
    }

    // è·å–æ‰€æœ‰æ ‡é¢˜
    const headings = content.querySelectorAll('h2, h3');

    if (headings.length === 0) {
      document.querySelector('.doc-toc').style.display = 'none';
      if (mobileTocToggle) {
        mobileTocToggle.style.display = 'none';
      }
      return;
    }

    // ä¸ºæ¯ä¸ªæ ‡é¢˜æ·»åŠ ID
    headings.forEach((heading, index) => {
      if (!heading.id) {
        heading.id = 'heading-' + index;
      }
    });

    // ç”Ÿæˆç›®å½•HTML
    let tocHTML = '<ul class="toc-list">';
    headings.forEach((heading) => {
      const level = heading.tagName === 'H2' ? 'toc-level-1' : 'toc-level-2';
      tocHTML += `
        <li class="${level}">
          <a href="#${heading.id}" class="toc-link">${heading.textContent}</a>
        </li>
      `;
    });
    tocHTML += '</ul>';

    // åŒæ—¶æ›´æ–°æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯ç›®å½•
    tocNav.innerHTML = tocHTML;
    if (mobileTocNav) {
      mobileTocNav.innerHTML = tocHTML;
    }

    // ç§»åŠ¨ç«¯ç›®å½•æŠ˜å åŠŸèƒ½
    if (mobileTocBtn && mobileTocContent) {
      mobileTocBtn.addEventListener('click', function() {
        const isOpen = mobileTocContent.classList.toggle('open');
        const arrow = this.querySelector('.toc-arrow');
        arrow.textContent = isOpen ? 'â–²' : 'â–¼';
      });

      // ç‚¹å‡»ç§»åŠ¨ç«¯ç›®å½•é“¾æ¥åè‡ªåŠ¨æŠ˜å 
      const mobileTocLinks = mobileTocNav.querySelectorAll('.toc-link');
      mobileTocLinks.forEach(link => {
        link.addEventListener('click', function() {
          mobileTocContent.classList.remove('open');
          const arrow = mobileTocBtn.querySelector('.toc-arrow');
          arrow.textContent = 'â–¼';
        });
      });
    }

    // åˆå§‹åŒ–ä½ç½®
    updateTocPosition();
    window.addEventListener('scroll', updateTocPosition);
    window.addEventListener('resize', updateTocPosition);

    // å¹³æ»‘æ»šåŠ¨ï¼ˆæ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯é€šç”¨ï¼‰
    const allTocLinks = document.querySelectorAll('.toc-link');
    allTocLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('href').substring(1);
        const targetElement = document.getElementById(targetId);
        if (targetElement) {
          targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
          // æ›´æ–°URLä½†ä¸æ»šåŠ¨
          history.pushState(null, null, '#' + targetId);
        }
      });
    });

    // æ»šåŠ¨é«˜äº®
    let isScrolling = false;

    function highlightTOC() {
      if (isScrolling) return;

      let current = '';
      const scrollPosition = window.scrollY + 100;

      headings.forEach(heading => {
        const headingTop = heading.offsetTop;
        if (scrollPosition >= headingTop) {
          current = heading.id;
        }
      });

      allTocLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href') === '#' + current) {
          link.classList.add('active');
        }
      });
    }

    window.addEventListener('scroll', highlightTOC);
    highlightTOC(); // åˆå§‹åŒ–
  });
</script>
